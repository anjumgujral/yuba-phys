---
title: "06_PLC"
author: "Anjum K. Gujral"
date: '2024-08-25'
output: html_document
---

```{r}
DATADIR = "/Users/anjumgujral/Box Sync/yuba-phys_data/traits"
# load in 2024 and 2024 cleaned hydraulics data
vulnerability_curves <- read.csv("yuba-phys-vulnerability-curve-cleaned-data-2024_2025.csv")

library(dplyr)
library(fitplc)

# run this for 2024 and 2025 vulnerability curve data

# list of unique combinations of tree IDs and year 
tree_ID_year <- vulnerability_curves %>%
  distinct(tree, year)

# empty lists to store results
model_list <- list()
coef_list  <- list()

# loop through all tree Ã— year combinations
for (i in seq_len(nrow(tree_ID_year))) {
  t <- tree_ID_year$tree[i]
  y <- tree_ID_year$year[i]

  # subset for one tree-year
  stemID <- vulnerability_curves %>%
    filter(tree == t, year == y) %>%
    mutate(
      k = format(k, scientific = FALSE),
      valid_data = plc_new >= 0
    )

  # skip if no valid data
  if (sum(stemID$valid_data) == 0) {
    warning(paste("No valid data for tree", t, "year", y))
    next
  }

  # fit plc model
  pfit <- fitplc(
    stemID %>% filter(valid_data),
    varnames = c(PLC = "plc_new", WP = "mpa"),
    nboot = 50
  )

  # plot with tree + year label
  plot(
    pfit,
    xlim = c(0, 7),
    ylim = c(0, 1),
    main = paste("tree ID", t, "- year", y)
  )

  # unique key prevents overwriting
  key <- paste(t, y, sep = "_")

  model_list[[key]] <- pfit
}

coef_df <- bind_rows(
  lapply(names(model_list), function(key) {

    parts <- strsplit(key, "_")[[1]]

    data.frame(
      tree = parts[1],
      year = as.integer(parts[2]),
      t(coef(model_list[[key]])),
      row.names = NULL
    )
  })
)

print(coef_df)


```


